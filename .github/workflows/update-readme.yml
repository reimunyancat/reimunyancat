name: Update README

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Create update script
        run: |
          cat > update-readme.js << 'EOF'
          const https = require('https');
          const fs = require('fs');

          function httpGet(url, headers = {}) {
            return new Promise((resolve, reject) => {
              const req = https.get(url, { headers }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (err) {
                    reject(err);
                  }
                });
              });
              req.on('error', reject);
            });
          }

          (async () => {
            try {
              const repos = await httpGet('https://api.github.com/users/reimunyancat/repos?sort=updated&per_page=50', {
                'Authorization': 'token ' + process.env.GITHUB_TOKEN,
                'User-Agent': 'GitHub-Actions'
              });
              
              const filtered = repos.filter(r => !r.fork && !r.private);
              const latest = filtered.slice(0, 6);
              
              let readme = fs.readFileSync('README.md', 'utf8');
              
              // Generate repository cards
              let cards = '';
              for (let i = 0; i < latest.length; i += 2) {
                cards += '  <tr>\n';
                if (latest[i]) {
                  const repoUrl = latest[i].html_url;
                  const repoName = latest[i].name;
                  cards += `    <td><a href="${repoUrl}"><img src="https://github-readme-stats.vercel.app/api/pin/?username=reimunyancat&repo=${repoName}&theme=vue&hide_border=true"></a></td>\n`;
                }
                if (latest[i + 1]) {
                  const repoUrl = latest[i + 1].html_url;
                  const repoName = latest[i + 1].name;
                  cards += `    <td><a href="${repoUrl}"><img src="https://github-readme-stats.vercel.app/api/pin/?username=reimunyancat&repo=${repoName}&theme=vue&hide_border=true"></a></td>\n`;
                } else {
                  cards += '    <td align="center"><strong style="color:#00b894;">üöß More Coming Soon! üöß</strong></td>\n';
                }
                cards += '  </tr>\n';
              }
              
              // Update README
              const repoSection = `<!--START_SECTION:repos-->\n<table>\n${cards}</table>\n<!--END_SECTION:repos-->`;
              readme = readme.replace(
                /<!--START_SECTION:repos-->[\s\S]*?<!--END_SECTION:repos-->/,
                repoSection
              );
              
              fs.writeFileSync('README.md', readme);
              console.log('‚úÖ README updated successfully!');
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              process.exit(1);
            }
          })();
          EOF

      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node update-readme.js

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "ü§ñ Auto-update README with latest repositories"
          git push
